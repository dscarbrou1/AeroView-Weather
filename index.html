<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroView Weather App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for background and font */
        body {
            font-family: 'Inter', sans-serif;
            /* Fallback/Initial Gradient (will be overwritten by image) */
            background: linear-gradient(135deg, #e0f2fe 0%, #d1e5ff 100%); 
            /* New properties for dynamic image background */
            background-size: cover;
            background-attachment: fixed; 
            background-position: center;
            transition: background-image 1s ease-in-out;
            
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* Increased max width for more content space */
        #app {
            max-width: 48rem; /* Increased from max-w-xl (36rem) to 48rem */
            width: 95%; /* Use 95% of screen width up to max-width */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            height: 8px; /* Height for horizontal scrollbar */
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        /* Style for the active unit button */
        .unit-active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5), 0 2px 4px -2px rgba(59, 130, 246, 0.5); /* glow effect */
        }
        .unit-inactive {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
        }
        /* History Item Focus Override */
        #cityInput:focus + #historyContainer > #historyDisplay {
            display: block;
        }
        /* Spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Error Shake Animation for the Search Button */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* --- IMMERSIVE ANIMATION STYLES --- */

        /* Animation for sun rotation */
        @keyframes sun-rotate {
            to { transform: rotate(360deg); }
        }
        /* Animation for gentle cloud movement */
        @keyframes cloud-move {
            0% { transform: translateX(0); }
            50% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        /* Animation for raindrops falling */
        @keyframes rain-fall {
            0% { transform: translateY(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        /* Animation for snow falling */
        @keyframes snow-fall {
            0% { transform: translate(0, -10px); opacity: 0; }
            100% { transform: translate(10px, 10px); opacity: 1; }
        }

        /* Applying animations */
        .animated-sun {
            animation: sun-rotate 12s linear infinite;
            transform-origin: 50% 50%;
        }
        .animated-cloud {
            animation: cloud-move 6s ease-in-out infinite alternate;
        }
        .animated-rain {
            animation: rain-fall 1s linear infinite;
        }
        .animated-snow {
            animation: snow-fall 2s linear infinite;
        }
        
        /* Hourly Scroll Container */
        .hourly-scroll {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 0.5rem; /* Space for scrollbar */
        }
        .hourly-card {
            display: inline-block;
            width: 6rem; /* Fixed width for each hourly card */
            min-width: 6rem;
            margin-right: 0.5rem;
            vertical-align: top;
        }

        /* Styling the date selector buttons */
        .date-selector-active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        /* Seasonal Snow Animation */
        .snow {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .snow-flake {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #ffffff;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }
    </style>
</head>
<body>

    <div id="snow-container" class="snow"></div>

    <div id="app" class="bg-white/90 p-6 md:p-8 rounded-3xl shadow-2xl transition-all duration-300">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800">AeroView</h1>
            <p class="text-sm text-gray-500 mt-1">Check the current conditions anywhere in the world.</p>
        </header>
        
        <!-- Severe Weather Alert Banner (Highest Priority) -->
        <div id="alertBanner" class="hidden p-3 mb-4 rounded-lg bg-red-100 border border-red-400 text-red-700 font-semibold flex items-center shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-12a1 1 0 102 0V9a1 1 0 10-2 0V6zm0 5a1 1 0 102 0 1 1 0 00-2 0z" clip-rule="evenodd" />
            </svg>
            <span id="alertContent"></span>
        </div>

        <!-- Input Section -->
        <div class="flex space-x-3 mb-4">
            <div class="relative flex-grow">
                <input type="text" id="cityInput" placeholder="Enter city name or use location..." 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner">
                <!-- Refresh Button (Hidden until successful search) -->
                <button id="refreshButton" 
                        class="absolute right-0 top-0 h-full w-12 bg-blue-500 hover:bg-blue-600 text-white rounded-r-lg shadow-md transition duration-150 flex items-center justify-center"
                        style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v1h2a1 1 0 011 1v2a1 1 0 01-1 1H5v2h2a1 1 0 011 1v2a1 1 0 01-1 1H5v1a1 1 0 01-2 0v-1H2a1 1 0 01-1-1v-2a1 1 0 011-1h1V8H2a1 1 0 01-1-1V5a1 1 0 011-1h1V3a1 1 0 011-1zm6.5 7.728l3.182-3.182a4 4 0 00-5.657-5.657L6.818 3.343a6 6 0 118.485 8.485l-3.182 3.182a1 1 0 01-1.414-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Search Button (Visible initially, toggles with Refresh) -->
            <button id="searchButton" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-105 active:scale-95">
                Search
            </button>
        </div>

        <!-- Search History List/Suggestions Dropdown -->
        <div id="historyContainer" class="relative">
            <div id="historyDisplay" 
                 class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-xl max-h-48 overflow-y-auto mt-[-10px] hidden">
                <div id="historyHeader" class="flex justify-between items-center p-2 border-b text-gray-500 text-xs font-semibold">
                    <span id="dropdownTitle">Recent Searches</span>
                    <button id="clearHistoryBtn" class="text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded transition duration-150" title="Clear All History">
                        Clear
                    </button>
                </div>
                <div id="dropdownList">
                    <!-- Suggestions or History items injected here -->
                </div>
            </div>
        </div>

        <!-- Unit and Detail Toggles Container -->
        <div class="flex justify-center flex-wrap gap-x-6 gap-y-3 mb-6 mt-4">
            <!-- Unit Toggle -->
            <div id="unitToggle" class="flex p-1 bg-gray-200 rounded-lg shadow-inner">
                <button id="celsiusBtn" class="px-3 py-1 rounded-md text-sm font-bold transition">Â°C</button>
                <button id="fahrenheitBtn" class="px-3 py-1 rounded-md text-sm font-bold transition">Â°F</button>
            </div>

            <!-- Basic / Advanced Toggle -->
            <div id="detailToggle" class="flex p-1 bg-gray-200 rounded-lg shadow-inner">
                <button id="basicBtn" class="px-3 py-1 rounded-md text-sm font-bold transition">Basic</button>
                <button id="advancedBtn" class="px-3 py-1 rounded-md text-sm font-bold transition">Advanced</button>
            </div>
            
            <!-- 3D Map View -->
            <button id="mapBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-12a1 1 0 102 0V9a1 1 0 10-2 0V6zm0 5a1 1 0 102 0 1 1 0 00-2 0z" clip-rule="evenodd" />
                </svg>
                View 3D Map
            </button>
        </div>

        <!-- Message Area (Errors/Information) -->
        <div id="messageArea" class="text-center text-red-500 font-medium mb-4" style="display: none;"></div>
        
        <!-- AI INSIGHT CARD -->
        <div id="insightCard" class="hidden p-4 mb-6 bg-white rounded-xl shadow-lg border-l-4 border-blue-500">
            <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1H6a.5.5 0 01-.5-.5zm.5 2a.5.5 0 000 1h2a.5.5 0 000-1H6a.5.5 0 00-.5.5zm10-5a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zM16 8a.5.5 0 000 1h2a.5.5 0 000-1h-2z" />
                    <path fill-rule="evenodd" d="M18.442 8.796a4.43 4.43 0 011.025.267 1 1 0 01.533.888v.175a1 1 0 01-.225.641l-2.023 2.768a1 1 0 01-.98.375h-2.128a1 1 0 01-.914-.582 1 1 0 01.196-.924c.036-.04.07-.08.106-.12l1.62-1.74a1 1 0 00-.773-1.614h-3.414l.001 2.5a1 1 0 01-1 1H5a1 1 0 01-1-1v-2.5H.5a.5.5 0 010-1h3.5v-2.5a1 1 0 011-1h6.414a1 1 0 00.773-1.614l-1.62-1.74a1 1 0 01-.196-.924 1 1 0 01.914-.582h2.128a1 1 0 01.98.375l2.023 2.768a1 1 0 01.225.641v.175a.5.5 0 01-.533.488zM15 11h-2v2h2v-2zM7 11H5v2h2v-2z" clip-rule="evenodd"/>
                </svg>
                AeroView Insight
            </h3>
            <div id="insightContent" class="text-sm text-gray-600 italic">
                <!-- AI generated text goes here -->
            </div>
            <div id="insightLoading" class="text-sm text-gray-500 mt-2 italic flex items-center">
                <svg class="spinner h-4 w-4 mr-1 text-blue-500" viewBox="0 0 50 50">
                    <circle class="path" cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" style="stroke-dasharray: 80, 100; opacity: 0.7;"></circle>
                </svg>
                Generating AI summary...
            </div>
        </div>
        <!-- END AI INSIGHT CARD -->

        
        <!-- Loading Skeleton -->
        <div id="loadingSkeleton" class="hidden text-center p-6 bg-gray-100 rounded-3xl shadow-md transition-all duration-300">
            <div class="flex flex-col items-center">
                <svg class="spinner h-8 w-8 text-blue-500 mb-4" viewBox="0 0 50 50">
                    <circle class="path" cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" style="stroke-dasharray: 80, 100; opacity: 0.7;"></circle>
                </svg>
                <div class="h-4 bg-gray-300 rounded w-1/2 mb-4 animate-pulse"></div>
                <div class="h-24 bg-gray-300 rounded-lg w-full mb-4 animate-pulse"></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full">
                    <div class="h-8 bg-gray-300 rounded animate-pulse"></div>
                    <div class="h-8 bg-gray-300 rounded animate-pulse"></div>
                    <div class="h-8 bg-gray-300 rounded animate-pulse"></div>
                    <div class="h-8 bg-gray-300 rounded animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Initial/Welcome Content -->
        <div id="welcomeState" class="text-center p-6 bg-white rounded-3xl border border-gray-200 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Welcome to AeroView!</h2>
            <p class="text-gray-600 mb-4">Start by searching for a city, or grant location access to see your local weather.</p>
            <p class="text-sm text-blue-500 font-semibold flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                Try searching "London, UK" or "Dallas, TX"!
            </p>
        </div>
        
        <!-- Current Weather Card Display -->
        <div id="weatherDisplay" class="hidden text-center p-6 text-white rounded-3xl shadow-xl transform transition-all duration-500 scale-100 hover:scale-[1.02]">
            <!-- Current weather content will be injected here -->
        </div>

        <!-- Hourly Forecast Section -->
        <div id="hourlyForecastSection" class="hidden mt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3 text-center border-b pb-2">Hourly Forecast (Next 15 Hours)</h3>
            <div id="hourlyDisplay" class="hourly-scroll flex overflow-x-auto mt-4">
                <!-- Hourly forecast cards injected here -->
            </div>
        </div>

        <!-- 5-Day Forecast Section -->
        <div id="forecastSection" class="hidden mt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3 text-center border-b pb-2">5-Day Forecast</h3>
            <div id="forecastDisplay" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                <!-- Forecast cards will be injected here -->
            </div>
        </div>

        <!-- App Footer -->
        <footer class="mt-6 text-center text-sm text-gray-400">
            <button id="aboutBtn" class="hover:text-gray-600 transition underline">About this App</button>
        </footer>
    </div>
    
    <!-- About Modal -->
    <div id="aboutModal" class="modal-backdrop hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">About AeroView</h3>
            <p class="text-gray-700 mb-3">
                This modern web application was developed by you, the creator, as a comprehensive coding project.
            </p>
            <p class="text-gray-700 mb-4">
                Weather data is powered by the **OpenWeatherMap API**. AI Insights are generated by the **Gemini API**.
            </p>
            <button id="closeModalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">
                Close
            </button>
        </div>
    </div>


    <script>
        // --- API CONFIGURATION ---
        const OPENWEATHER_API_KEY = "9fcf1e73c7dc66afb1e248c5ef3bdbb3"; 
        const CURRENT_WEATHER_URL = "https://api.openweathermap.org/data/2.5/weather";
        const FORECAST_URL = "https://api.openweathermap.org/data/2.5/forecast";
        const ALERTS_URL = "https://api.openweathermap.org/data/2.5/onecall";
        const AQI_URL = "https://api.openweathermap.org/data/2.5/air_pollution";
        const ICON_URL = "https://openweathermap.org/img/wn/";
        // Base URL for dynamic image search (fallback)
        const CITY_IMAGE_BASE = "https://source.unsplash.com/random/1600x900/?";
        const GEMINI_API_KEY = "AIzaSyDraNdjH386L-xPRwPD7VDZejiQPfI_7BM"; // User's key
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + GEMINI_API_KEY;

        
        // --- STATIC CITY LIST FOR SUGGESTIONS (Restored pre-7-continent list) ---
        const CITY_LIST = [
            // North America
            "New York, NY", "Los Angeles, CA", "Chicago, IL", "Houston, TX", "Philadelphia, PA", "Phoenix, AZ", "San Antonio, TX",
            "San Diego, CA", "Dallas, TX", "San Jose, CA", "Austin, TX", "Las Vegas, NV", "Miami, FL", "Boston, MA", 
            "Seattle, WA", "Denver, CO", "Reno, NV", "Mount Charleston, NV", "Birmingham, AL", 
            "Toronto, CA", "Vancouver, CA", "Montreal, CA", "Mexico City, MX", "Guadalajara, MX", "Morelia, Michoacan, MX", 
            "Havana, CU", "Kingston, JM", "San Juan, PR",
            // South America
            "Sao Paulo, BR", "Rio de Janeiro, BR", "Buenos Aires, AR", "Lima, PE", "Santiago, CL", "Bogota, CO",
            "Caracas, VE", "Quito, EC", "Montevideo, UY", "La Paz, BO",
            // Europe
            "London, UK", "Paris, FR", "Berlin, DE", "Rome, IT", "Madrid, ES", "Moscow, RU", "Amsterdam, NL", 
            "Stockholm, SE", "Oslo, NO", "Vienna, AT", "Warsaw, PL", "Dublin, IE", "Copenhagen, DK", "Zurich, CH",
            "Athens, GR", "Lisbon, PT", "Istanbul, TR",
            // Asia
            "Tokyo, JP", "Beijing, CN", "Mumbai, IN", "Shanghai, CN", "Seoul, KR", "Bangkok, TH", "Jakarta, ID",
            "Manila, PH", "Hanoi, VN", "Riyadh, SA", "Dubai, AE", "Singapore, SG", "Hong Kong, HK", "Taipei, TW",
            "Kuala Lumpur, MY", "Tel Aviv, IL",
            // Africa
            "Cairo, EG", "Lagos, NG", "Kinshasa, CD", "Johannesburg, ZA", "Nairobi, KE", "Casablanca, MA", 
            "Algiers, DZ", "Accra, GH", "Dakar, SN", "Cape Town, ZA",
            // Australia/Oceania
            "Sydney, AU", "Melbourne, AU", "Brisbane, AU", "Perth, AU", "Auckland, NZ", "Wellington, NZ", 
            "Suva, FJ", "Port Moresby, PG",
            // Antarctica
            "McMurdo Station, AQ", "Amundsen-Scott Station, AQ", "Vostok Station, AQ", "Palmer Station, AQ",
            // US States for Search Clarity
            "California, US", "Texas, US", "Florida, US", "Illinois, US", "Nevada, US", "Michigan, US",
            "New York, US", "Washington, US", "Colorado, US", "Massachusetts, US",
        ];

        // --- STATIC IMAGE MAPPING (Guaranteed City Images) ---
        const STATIC_CITY_IMAGES = {
            'NEW YORK': 'https://images.unsplash.com/photo-1546467005-0e10b240590a?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'LONDON': 'https://images.unsplash.com/photo-1533929780004-945624128521?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'PARIS': 'https://images.unsplash-lite.com/photo-1502602898624-ad4b2a8d5811?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'TOKYO': 'https://images.unsplash-lite.com/photo-1540679776092-d96a99991d1a?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'SYDNEY': 'https://images.unsplash-lite.com/photo-1582260656515-f5be870c538a?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'DUBAI': 'https://images.unsplash-lite.com/photo-1512495679313-264639902633?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
            'LAS VEGAS': 'https://images.unsplash-lite.com/photo-1550503046-e5c9a444d47c?q=80&w=1400&h=900&fit=crop&cs=tinysrgb',
        };

        // --- STATE MAP FOR US CITIES ---
        const US_STATE_MAP = {
            'AL': 'AL', 'AK': 'AK', 'AZ': 'AZ', 'AR': 'AR', 'CA': 'CA', 'CO': 'CO', 'CT': 'CT', 'DE': 'DE', 'DC': 'DC', 'FL': 'FL', 'GA': 'GA', 'HI': 'HI', 'ID': 'ID', 'IL': 'IL', 'IN': 'IN', 'IA': 'IA', 'KS': 'KS', 'KY': 'KY', 'LA': 'LA', 'ME': 'ME', 'MD': 'MD', 'MA': 'MA', 'MI': 'MI', 'MN': 'MN', 'MS': 'MS', 'MO': 'MO', 'MT': 'MT', 'NE': 'NE', 'NV': 'NV', 'NH': 'NH', 'NJ': 'NJ', 'NM': 'NM', 'NY': 'NY', 'NC': 'NC', 'ND': 'ND', 'OH': 'OH', 'OK': 'OK', 'OR': 'OR', 'PA': 'PA', 'RI': 'RI', 'SC': 'SC', 'SD': 'SD', 'TN': 'TN', 'TX': 'TX', 'UT': 'UT', 'VT': 'VT', 'VA': 'VA', 'WA': 'WA', 'WV': 'WV', 'WI': 'WI', 'WY': 'WY',
        };

        // --- APP STATE ---
        let isCelsius = false; // Default to Fahrenheit
        let isAdvanced = true; // Default to Advanced
        let currentWeatherData = null;
        let forecastWeatherData = null;
        const MAX_HISTORY = 5;
        let selectedForecastDay = 0; // Index for selected day (0 = today)

        // --- DOM Elements ---
        const appContainer = document.getElementById('app');
        const cityInput = document.getElementById('cityInput');
        const searchButton = document.getElementById('searchButton');
        const refreshButton = document.getElementById('refreshButton');
        const weatherDisplay = document.getElementById('weatherDisplay');
        const forecastSection = document.getElementById('forecastSection');
        const forecastDisplay = document.getElementById('forecastDisplay');
        const messageArea = document.getElementById('messageArea');
        const celsiusBtn = document.getElementById('celsiusBtn');
        const fahrenheitBtn = document.getElementById('fahrenheitBtn');
        const basicBtn = document.getElementById('basicBtn');
        const advancedBtn = document.getElementById('advancedBtn');
        const historyDisplay = document.getElementById('historyDisplay');
        const dropdownTitle = document.getElementById('dropdownTitle');
        const dropdownList = document.getElementById('dropdownList');
        const loadingSkeleton = document.getElementById('loadingSkeleton');
        const welcomeState = document.getElementById('welcomeState');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn'); 
        const aboutBtn = document.getElementById('aboutBtn'); 
        const aboutModal = document.getElementById('aboutModal'); 
        const closeModalBtn = document.getElementById('closeModalBtn'); 
        const mapBtn = document.getElementById('mapBtn');
        const hourlyForecastSection = document.getElementById('hourlyForecastSection');
        const hourlyDisplay = document.getElementById('hourlyDisplay');
        const alertBanner = document.getElementById('alertBanner');
        const alertContent = document.getElementById('alertContent');
        const insightCard = document.getElementById('insightCard');
        const insightContent = document.getElementById('insightContent');
        const insightLoading = document.getElementById('insightLoading');
        const snowContainer = document.getElementById('snow-container');


        // --- CORE UTILITY FUNCTIONS ---

        // Function to display messages (errors or loading)
        function showMessage(text, isError = false) {
            weatherDisplay.classList.add('hidden');
            forecastSection.classList.add('hidden'); 
            hourlyForecastSection.classList.add('hidden');
            welcomeState.classList.add('hidden'); 
            loadingSkeleton.classList.add('hidden');
            insightCard.classList.add('hidden');
            alertBanner.classList.add('hidden');
            refreshButton.style.display = 'none';
            searchButton.style.display = 'block';

            messageArea.textContent = text;
            messageArea.style.display = 'block';
            messageArea.className = `text-center font-medium mb-4 ${isError ? 'text-red-500' : 'text-gray-600'}`;

            if (isError) {
                // Error Visualization: Shake the button and flash the container border
                searchButton.classList.add('error-shake');
                appContainer.style.border = '2px solid #f87171'; // Red-400
                setTimeout(() => {
                    searchButton.classList.remove('error-shake');
                    appContainer.style.border = 'none';
                }, 500);
            }
        }

        // Function to clear messages
        function clearMessage() {
            messageArea.textContent = '';
            messageArea.style.display = 'none';
        }

        // Function to show the loading state
        function showLoading() {
            welcomeState.classList.add('hidden'); 
            weatherDisplay.classList.add('hidden');
            forecastSection.classList.add('hidden');
            hourlyForecastSection.classList.add('hidden');
            messageArea.style.display = 'none';
            insightCard.classList.add('hidden');
            alertBanner.classList.add('hidden');
            refreshButton.style.display = 'none';
            searchButton.style.display = 'block';
            loadingSkeleton.classList.remove('hidden');
            cityInput.blur(); // Hide dropdown while loading
        }

        // Function to show the welcome state
        function showWelcome() {
            loadingSkeleton.classList.add('hidden');
            weatherDisplay.classList.add('hidden');
            forecastSection.classList.add('hidden');
            hourlyForecastSection.classList.add('hidden');
            messageArea.style.display = 'none';
            insightCard.classList.add('hidden');
            alertBanner.classList.add('hidden');
            refreshButton.style.display = 'none';
            searchButton.style.display = 'block';
            welcomeState.classList.remove('hidden');
            cityInput.value = '';
        }

        // Converts Kelvin to Celsius
        function toCelsius(kelvin) {
            return kelvin - 273.15;
        }

        // Converts Celsius to Fahrenheit
        function toFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }
        
        // CRITICAL FIX: Converts temperature based on current unit state (returns rounded number)
        function convertTemp(kelvin) {
            const celsius = toCelsius(kelvin);
            
            if (isCelsius) {
                return Math.round(celsius); 
            } else {
                // Ensure conversion is always Celsius -> Fahrenheit
                const fahrenheit = toFahrenheit(celsius); 
                return Math.round(fahrenheit); 
            }
        }

        // Wind Speed conversion: m/s (API default) to desired unit
        function convertWindSpeed(metersPerSecond) {
            if (isCelsius) {
                // To km/h (m/s * 3.6)
                return { value: (metersPerSecond * 3.6).toFixed(1), unit: 'km/h' };
            } else {
                // To mph (m/s * 2.237)
                return { value: (metersPerSecond * 2.237).toFixed(1), unit: 'mph' };
            }
        }

        // Formats UNIX timestamp into local time (e.g., 6:30 PM) for the city's timezone
        function formatTime(unixTimestamp, timezoneOffset) {
            const date = new Date((unixTimestamp + timezoneOffset) * 1000);
            // Use UTC methods and timezone offset to simulate local time
            const hours = date.getUTCHours();
            const minutes = date.getUTCMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${displayHours}:${displayMinutes} ${ampm}`;
        }

        // Formats UNIX timestamp to Day Name (Mon, Tue)
        function getDayName(unixTimestamp) {
            const date = new Date(unixTimestamp * 1000);
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        // Formats UNIX timestamp to Time (12 PM)
        function getHourTime(unixTimestamp) {
            const date = new Date(unixTimestamp * 1000);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
        }
        
        // --- DATA PERSISTENCE (localStorage) ---

        function saveSetting(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("Could not save setting:", e);
            }
        }

        function loadSetting(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue === null) return defaultValue;
                return JSON.parse(storedValue);
            } catch (e) {
                console.error("Could not load setting:", e);
                return defaultValue;
            }
        }

        function loadState() {
            // Load Unit/Detail Preference (Fahrenheit is default now)
            isCelsius = loadSetting('isCelsius', false);
            isAdvanced = loadSetting('isAdvanced', true);

            // Apply loaded state to buttons
            celsiusBtn.classList.toggle('unit-active', isCelsius);
            celsiusBtn.classList.toggle('unit-inactive', !isCelsius);
            fahrenheitBtn.classList.toggle('unit-active', !isCelsius);
            fahrenheitBtn.classList.toggle('unit-inactive', isCelsius);

            basicBtn.classList.toggle('unit-active', !isAdvanced);
            basicBtn.classList.toggle('unit-inactive', isAdvanced);
            advancedBtn.classList.toggle('unit-active', isAdvanced);
            advancedBtn.classList.toggle('unit-inactive', !isAdvanced);
        }
        
        // Save Search History
        function saveSearchHistory(city) {
            city = city.trim();
            if (!city) return;

            let history = loadSetting('searchHistory', []);
            
            // Remove the city if it already exists to move it to the front
            history = history.filter(h => h.toLowerCase() !== city.toLowerCase());

            // Add new city to the front
            history.unshift(city);

            // Limit history size
            if (history.length > MAX_HISTORY) {
                history.pop();
            }

            saveSetting('searchHistory', history);
        }

        // Load and Render Search History/Suggestions
        function renderSearchDropdown(query = '') {
            query = query.trim().toLowerCase();
            dropdownList.innerHTML = '';
            historyDisplay.classList.add('hidden');
            dropdownTitle.textContent = 'Recent Searches';
            
            if (query.length > 0) {
                // SUGGESTIONS MODE
                const suggestions = CITY_LIST.filter(city => city.toLowerCase().includes(query)).slice(0, 8);
                
                if (suggestions.length > 0) {
                    dropdownTitle.textContent = `Suggestions for "${query}"`;
                    clearHistoryBtn.style.display = 'none'; // Hide clear button in suggestion mode
                    dropdownDisplay(suggestions, 'suggestion');
                } else {
                    return;
                }
            } else {
                // HISTORY MODE
                const history = loadSetting('searchHistory', []);
                if (history.length > 0) {
                    dropdownTitle.textContent = 'Recent Searches';
                    clearHistoryBtn.style.display = 'block'; // Show clear button in history mode
                    dropdownDisplay(history, 'history');
                } else {
                    return;
                }
            }
        }

        function dropdownDisplay(items, type) {
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.textContent = item;
                itemEl.className = 'p-2 cursor-pointer text-gray-700 hover:bg-blue-100 transition duration-150';
                itemEl.onmousedown = (e) => { // Use mousedown to prevent blur event from hiding dropdown
                    e.preventDefault();
                    cityInput.value = item;
                    historyDisplay.classList.add('hidden');
                    getWeather(); // Trigger search immediately on click
                };
                dropdownList.appendChild(itemEl);
            });
            historyDisplay.classList.remove('hidden');
        }

        // --- DYNAMIC VISUALS ---

        // Sets the background image based on the city name
        function setCityBackground(cityName) {
            // Clean name for lookup (e.g., "Las Vegas, NV" -> "LAS VEGAS")
            const cleanCityName = cityName.split(',')[0].trim().toUpperCase();
            
            let imageUrl = STATIC_CITY_IMAGES[cleanCityName];

            if (!imageUrl) {
                // Fallback to dynamic search if not in static list
                // Search specifically for the city name, plus 'skyline' or 'city'
                const encodedQuery = encodeURIComponent(`${cityName} skyline city`);
                imageUrl = `${CITY_IMAGE_BASE}${encodedQuery}`;
            }

            // Fallback to a highly stable placeholder if static/dynamic fails
            const stableFallback = 'https://picsum.photos/1600/900?blur=1'; 

            const img = new Image();
            img.onload = () => {
                document.body.style.backgroundImage = `url('${imageUrl}')`;
            };
            img.onerror = () => {
                // If the city-specific/dynamic image fails, use the stable fallback
                document.body.style.backgroundImage = `url('${stableFallback}')`;
            };
            img.src = imageUrl; // Start loading the image
        }
        
        // Maps weather condition codes to Tailwind colors/gradients
        function getBackgroundColor(conditionId) {
            if (conditionId >= 200 && conditionId < 300) return 'from-gray-900 to-gray-600 bg-gradient-to-br'; // Thunderstorm
            if (conditionId >= 300 && conditionId < 600) return 'from-gray-500 to-blue-500 bg-gradient-to-br'; // Drizzle/Rain
            if (conditionId >= 600 && conditionId < 700) return 'from-blue-200 to-white bg-gradient-to-br text-gray-800'; // Snow
            if (conditionId >= 700 && conditionId < 800) return 'from-gray-400 to-gray-200 bg-gradient-to-br text-gray-800'; // Atmosphere (Fog/Mist)
            if (conditionId === 800) return 'from-yellow-400 to-orange-500 bg-gradient-to-br'; // Clear
            if (conditionId === 801) return 'from-yellow-300 to-blue-500 bg-gradient-to-br'; // Few clouds
            if (conditionId > 801) return 'from-gray-500 to-gray-700 bg-gradient-to-br'; // Clouds
            return 'from-indigo-500 to-blue-600 bg-gradient-to-br'; // Default
        }

        // Maps weather condition codes to animated SVG icons
        function getAnimatedIcon(iconCode, size = 'w-24 h-24') {
            const iconType = iconCode.substring(0, 2);
            const color = 'white'; // Icon color for most backgrounds
            const sunColor = '#f59e0b'; // Amber for sun
            const cloudColor = '#e5e7eb'; // Gray-200 for clouds

            let svgContent = '';

            switch (iconType) {
                case '01': // Clear Sky (Day/Night)
                    svgContent = `
                        <svg class="${size} ${iconCode.includes('d') ? 'animated-sun' : ''}" viewBox="0 0 24 24" fill="none" stroke="${iconCode.includes('d') ? sunColor : cloudColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            ${iconCode.includes('d') ? '<circle cx="12" cy="12" r="5" fill="' + sunColor + '"/>' : '<path d="M12 1.58A7.962 7.962 0 0010 2a8 8 0 000 16c2.4 0 4.6-.9 6.2-2.3l-2.2-2.2A4.5 4.5 0 0110 13a4.5 4.5 0 014.5-4.5h-.5A8 8 0 0012 1.58z" fill="' + cloudColor + '" stroke="' + color + '"/>'}
                        </svg>`;
                    break;
                case '02': // Few Clouds
                case '03': // Scattered Clouds
                case '04': // Broken Clouds
                    svgContent = `
                        <svg class="${size}" viewBox="0 0 24 24" fill="none" stroke="${cloudColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path class="animated-cloud" d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 004.58-7H22a2 2 0 00-2-2z" fill="${cloudColor}" stroke="${cloudColor}"/>
                            <circle cx="7" cy="15" r="3" fill="${cloudColor}" stroke="${cloudColor}"/>
                        </svg>`;
                    break;
                case '09': // Shower Rain
                case '10': // Rain
                    svgContent = `
                        <svg class="${size}" viewBox="0 0 24 24" fill="none" stroke="${cloudColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 004.58-7H22a2 2 0 00-2-2z" fill="${cloudColor}" stroke="${cloudColor}"/>
                            <line class="animated-rain" x1="12" y1="18" x2="12" y2="22" stroke="${color}"/>
                            <line class="animated-rain" x1="8" y1="18" x2="8" y2="22" stroke="${color}"/>
                            <line class="animated-rain" x1="16" y1="18" x2="16" y2="22" stroke="${color}"/>
                        </svg>`;
                    break;
                case '13': // Snow
                    svgContent = `
                        <svg class="${size}" viewBox="0 0 24 24" fill="none" stroke="${cloudColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 004.58-7H22a2 2 0 00-2-2z" fill="${cloudColor}" stroke="${cloudColor}"/>
                            <circle class="animated-snow" cx="12" cy="18" r="1" fill="${color}" stroke="none"/>
                            <circle class="animated-snow" cx="8" cy="16" r="1" fill="${color}" stroke="none"/>
                            <circle class="animated-snow" cx="16" cy="20" r="1" fill="${color}" stroke="none"/>
                        </svg>`;
                    break;
                case '11': // Thunderstorm
                    svgContent = `
                        <svg class="${size}" viewBox="0 0 24 24" fill="none" stroke="${cloudColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 004.58-7H22a2 2 0 00-2-2z" fill="${cloudColor}" stroke="${cloudColor}"/>
                            <path d="M13 14l-3 5h4l-3 5" stroke="${sunColor}" fill="none"/>
                        </svg>`;
                    break;
                default:
                    // Default to simple icon from OpenWeatherMap CDN
                    return `<img src="${ICON_URL}${iconCode}@2x.png" alt="Weather Icon" class="mx-auto ${size}" />`;
            }
            return `<div class="mx-auto ${size} flex items-center justify-center">${svgContent}</div>`;
        }

        // Applies seasonal decorations to the background
        function applySeasonalDecorations() {
            const date = new Date();
            const month = date.getMonth(); // 0 (Jan) to 11 (Dec)
            const day = date.getDate();

            const body = document.body;
            const snowContainer = document.getElementById('snow-container');
            
            // Clear previous decorations
            body.style.setProperty('--spring-emoji', 'none');
            body.style.setProperty('--fall-emoji', 'none');
            snowContainer.innerHTML = '';
            
            // --- 1. Winter/Holidays (Nov 20 - Jan 5) ---
            if ((month === 10 && day >= 20) || month === 11 || (month === 0 && day <= 5)) {
                
                // Add snow class to body for snow-like gradient
                body.classList.add('winter'); 
                
                // Falling snow animation (100 flakes)
                for (let i = 0; i < 100; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snow-flake';
                    flake.style.left = `${Math.random() * 100}vw`;
                    flake.style.animationDuration = `${Math.random() * 2 + 3}s`; // 3 to 5 seconds
                    flake.style.animationDelay = `${Math.random() * 5}s`;
                    flake.style.opacity = `${Math.random() * 0.5 + 0.3}`;
                    flake.style.fontSize = `${Math.random() * 3 + 1}px`;
                    snowContainer.appendChild(flake);
                }
            } else {
                body.classList.remove('winter');
            }
            
            // --- 2. Spring/Easter (March 15 - May 1) ---
            if ((month === 2 && day >= 15) || month === 3 || (month === 4 && day <= 1)) {
                body.style.setProperty('--spring-emoji', '"ðŸŒ·"');
                body.style.setProperty('background-color', '#f0f9ff'); // Light blue background
            }

            // --- 3. Fall/Halloween (Sept 15 - Nov 15) ---
            if ((month === 8 && day >= 15) || month === 9 || (month === 10 && day <= 15)) {
                body.style.setProperty('--fall-emoji', '"ðŸŽƒ"');
                body.style.setProperty('background-color', '#fff7ed'); // Off-white/cream background
            }
        }


        // --- DISPLAY FUNCTIONS ---

        // Sets the selected day for the hourly forecast
        function selectForecastDay(dayIndex) {
            selectedForecastDay = dayIndex;
            renderHourlyForecast();
            // Update button styles
            forecastDisplay.querySelectorAll('div').forEach((dayEl, index) => {
                dayEl.querySelector('button').classList.remove('date-selector-active');
                if (index === dayIndex) {
                    dayEl.querySelector('button').classList.add('date-selector-active');
                }
            });
        }

        // Renders the hourly forecast for the selected day
        function renderHourlyForecast() {
            hourlyDisplay.innerHTML = '';
            
            if (!forecastWeatherData || !forecastWeatherData.list) return;

            // Find the starting index for the selected day
            const dayStart = selectedForecastDay * 8; 
            const hourlyList = forecastWeatherData.list.slice(dayStart, dayStart + 8);
            
            // Limit to max 15 hours for clean display (since data is 3-hour chunks, we take max 8 entries, which is 24 hours)
            hourlyList.slice(0, 5).forEach(item => {
                const temp = convertTemp(item.main.temp);
                const time = getHourTime(item.dt);
                const iconCode = item.weather[0].icon;

                const cardHtml = `
                    <div class="hourly-card bg-gray-100 p-2 rounded-xl shadow-md text-center text-gray-800 transition transform hover:scale-105">
                        <p class="text-xs font-semibold">${time}</p>
                        <img src="${ICON_URL}${iconCode}.png" alt="Icon" class="mx-auto h-8 w-8">
                        <p class="text-lg font-bold">${temp}Â°${isCelsius ? 'C' : 'F'}</p>
                        <p class="text-xs text-gray-500">${Math.round(item.pop * 100)}% chance</p>
                    </div>
                `;
                hourlyDisplay.innerHTML += cardHtml;
            });
            
            hourlyForecastSection.classList.remove('hidden');
        }

        // Renders the 5-Day forecast cards
        function displayForecast(data) {
            forecastDisplay.innerHTML = '';
            
            const forecastList = data.list;
            const dailyData = {};
            const MS_PER_DAY = 24 * 60 * 60 * 1000;

            forecastList.forEach(item => {
                const dateKey = new Date(item.dt * 1000).toDateString();
                
                // Store the Kelvin value for min/max calculation
                const temp = item.main.temp; 
                const icon = item.weather[0].icon;
                
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = {
                        temps: [],
                        icons: {},
                        dt: item.dt
                    };
                }
                dailyData[dateKey].temps.push(temp);
                dailyData[dateKey].icons[icon] = (dailyData[dateKey].icons[icon] || 0) + 1;
            });

            // Filter for the next 5 days
            const dailyKeys = Object.keys(dailyData).slice(0, 5); 

            dailyKeys.forEach((dateKey, index) => {
                const day = dailyData[dateKey];
                const dayName = getDayName(day.dt);

                // CRITICAL FIX: Convert all Kelvin temperatures to the current display unit (F or C)
                // before calculating Min/Max on the converted array.
                const convertedTemps = day.temps.map(convertTemp); 

                const minTemp = Math.min(...convertedTemps);
                const maxTemp = Math.max(...convertedTemps);

                // Determine the most frequent icon for the day
                const mostFrequentIcon = Object.keys(day.icons).reduce((a, b) => day.icons[a] > day.icons[b] ? a : b);
                // Get the description for the chosen icon (needed for alt text)
                const description = data.list.find(item => item.weather[0].icon === mostFrequentIcon)?.weather[0]?.description || 'weather';

                const cardHtml = `
                    <div class="text-gray-800 transition duration-300">
                        <button onclick="selectForecastDay(${index})" 
                                class="w-full p-2 rounded-xl shadow-md text-center bg-gray-100 transform hover:scale-105 transition ${index === selectedForecastDay ? 'date-selector-active' : ''}">
                            <p class="text-sm font-bold mb-1">${dayName}</p>
                            <img src="${ICON_URL}${mostFrequentIcon}.png" alt="${description}" class="mx-auto h-8 w-8">
                            <p class="text-xs font-semibold mt-1">${maxTemp}Â° / ${minTemp}Â°${isCelsius ? 'C' : 'F'}</p>
                        </button>
                    </div>
                `;
                forecastDisplay.innerHTML += cardHtml;
            });

            forecastSection.classList.remove('hidden');
            selectForecastDay(selectedForecastDay); // Render hourly forecast for the initially selected day
        }

        // Renders current weather details
        function displayCurrentWeather(data) {
            clearMessage();
            loadingSkeleton.classList.add('hidden');
            welcomeState.classList.add('hidden');
            weatherDisplay.classList.remove('hidden');
            
            // Get correct temperatures immediately using the fixed convertTemp
            const temp_K = data.main.temp;
            const feelsLike_K = data.main.feels_like;
            const temp_min_K = data.main.temp_min;
            const temp_max_K = data.main.temp_max;

            // Apply conversions for display
            const temp = convertTemp(temp_K);
            const feelsLike = convertTemp(feelsLike_K);
            const minTemp = convertTemp(temp_min_K);
            const maxTemp = convertTemp(temp_max_K);
            
            const condition = data.weather[0].description;
            const iconCode = data.weather[0].icon;
            const wind = convertWindSpeed(data.wind.speed);
            const humidity = data.main.humidity;
            
            const cityName = data.name;
            let displayCityName = cityName;

            // Fix for Mount Charleston/Summerlin issue: if API substitutes name, use search name
            if (cityInput.dataset.lastSearch && cityName.toUpperCase().includes('SUMMERLIN')) {
                displayCityName = cityInput.dataset.lastSearch.split(',')[0].trim();
            }

            // Fix for State/Country Display: check original search for state code
            let countryCode = data.sys.country;
            if (countryCode === 'US') {
                const searchParts = cityInput.dataset.lastSearch.split(',').map(s => s.trim().toUpperCase());
                const stateAbbreviation = searchParts.find(part => US_STATE_MAP[part]);
                if (stateAbbreviation) {
                    countryCode = stateAbbreviation;
                }
            }
            
            const sunrise = formatTime(data.sys.sunrise, data.timezone);
            const sunset = formatTime(data.sys.sunset, data.timezone);
            
            // Get Dynamic Background Gradient
            const bgGradient = getBackgroundColor(data.weather[0].id);
            weatherDisplay.className = `p-6 text-white rounded-3xl shadow-xl transform transition-all duration-500 scale-100 hover:scale-[1.02] ${bgGradient} text-center`;
            
            // Build the basic details HTML (always shown)
            let basicDetails = `
                <div class="text-3xl font-bold text-white mb-2">${displayCityName}, ${countryCode}</div>
                <div class="text-xl font-medium capitalize text-white opacity-90 mb-4">${condition}</div>
                <div class="flex justify-center items-center mb-6">
                    ${getAnimatedIcon(iconCode)}
                    <div class="text-8xl font-extrabold ml-4">${temp}<span class="align-top text-5xl">Â°${isCelsius ? 'C' : 'F'}</span></div>
                </div>
            `;

            // Advanced details are conditional
            const advancedDetailsHTML = `
                <div id="advancedDetails" class="grid grid-cols-2 gap-4 mt-6 text-sm font-semibold border-t border-white/30 pt-4">
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Sunrise</span>
                        <span>${sunrise}</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Sunset</span>
                        <span>${sunset}</span>
                    </div>
                    <div id="minMaxTemp" class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Min/Max</span>
                        <span>${maxTemp}Â° / ${minTemp}Â°${isCelsius ? 'C' : 'F'}</span>
                    </div>
                    <div id="pressureDetail" class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Pressure</span>
                        <span>${data.main.pressure} hPa</span>
                    </div>
                    <div id="visibilityDetail" class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Visibility</span>
                        <span>${(data.visibility / 1000).toFixed(1)} km</span>
                    </div>
                    <div id="aqiDetail" class="flex justify-between items-center bg-white/20 p-2 rounded-lg">
                        <span>Air Quality (AQI)</span>
                        <span id="aqiValue">--</span>
                    </div>
                </div>
            `;
            
            // Basic details appear in a separate grid structure
            const basicMetricsHTML = `
                <div id="basicMetrics" class="grid grid-cols-3 gap-4 text-sm font-semibold border-t border-white/30 pt-4 mt-4">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <div class="text-xs opacity-75">Feels Like</div>
                        <div class="text-xl font-bold">${feelsLike}Â°</div>
                    </div>
                    <div class="bg-white/20 p-2 rounded-lg">
                        <div class="text-xs opacity-75">Humidity</div>
                        <div class="text-xl font-bold">${humidity}%</div>
                    </div>
                    <div class="bg-white/20 p-2 rounded-lg">
                        <div class="text-xs opacity-75">Wind Speed</div>
                        <div class="text-xl font-bold">${wind.value}</div>
                        <div class="text-xs opacity-75">${wind.unit}</div>
                    </div>
                </div>
            `;

            weatherDisplay.innerHTML = basicDetails + basicMetricsHTML + (isAdvanced ? advancedDetailsHTML : '');
            
            // Post-render setup
            mapBtn.style.display = 'block';
            refreshButton.style.display = 'flex';
            searchButton.style.display = 'none';
            weatherDisplay.classList.remove('hidden');

            // Fetch secondary data (AQI, Alerts, AI Insight)
            fetchSecondaryData(data.coord.lat, data.coord.lon, cityName);
            
            // Save search to history and update background
            saveSearchHistory(cityInput.dataset.lastSearch);
            setCityBackground(cityInput.dataset.lastSearch);
            renderSearchDropdown(); 
        }

        // --- SECONDARY DATA FETCHING ---
        
        // Fetches Alerts, AQI, and triggers AI Insight generation
        async function fetchSecondaryData(lat, lon, cityName) {
            // Fetch Severe Weather Alerts
            fetchAlerts(lat, lon);
            
            // Fetch Air Quality Index (AQI)
            fetchAQI(lat, lon);

            // Generate AI Insight
            generateInsight(cityName, currentWeatherData);
        }

        // Fetches Severe Weather Alerts
        async function fetchAlerts(lat, lon) {
            try {
                // Must use the onecall API endpoint with metric units for alerts
                const url = `${ALERTS_URL}?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&exclude=current,minutely,hourly,daily`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.alerts && data.alerts.length > 0) {
                    const alert = data.alerts[0];
                    alertContent.textContent = `${alert.event} - Issued by ${alert.sender_name}`;
                    alertBanner.classList.remove('hidden');
                } else {
                    alertBanner.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching alerts:", error);
                alertBanner.classList.add('hidden');
            }
        }
        
        // Fetches Air Quality Index
        async function fetchAQI(lat, lon) {
            try {
                const url = `${AQI_URL}?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.list && data.list.length > 0) {
                    const aqi = data.list[0].main.aqi;
                    
                    let status = '';
                    let color = '';

                    switch (aqi) {
                        case 1: status = 'Good'; color = 'text-green-500'; break;
                        case 2: status = 'Fair'; color = 'text-yellow-500'; break;
                        case 3: status = 'Moderate'; color = 'text-orange-500'; break;
                        case 4: status = 'Poor'; color = 'text-red-500'; break;
                        case 5: status = 'Very Poor'; color = 'text-purple-500'; break;
                        default: status = 'N/A'; color = 'text-gray-400';
                    }

                    const aqiElement = document.getElementById('aqiValue');
                    if (aqiElement) {
                        aqiElement.textContent = `${aqi} (${status})`;
                        aqiElement.className = color + ' font-bold';
                    }
                }
            } catch (error) {
                console.error("Error fetching AQI:", error);
            }
        }

        // Analyzes forecast data to predict rain/snow timing (NEW)
        function displayPredictionTimeline(data) {
            // Note: This function remains the same as it correctly calculates time intervals regardless of temp unit.
            const list = data.list.slice(0, 8); // Next 24 hours (8 x 3-hour slots)
            let rainStart = null;
            let rainEnd = null;
            let isRain = false;
            let iconClass = 'sun-icon';
            let message = 'No significant precipitation expected in the next 24 hours.';
            let bannerColor = 'bg-green-100 border-green-400 text-green-700';

            for (let i = 0; i < list.length; i++) {
                const item = list[i];
                const conditionId = item.weather[0].id;
                
                // 300-599 is Rain/Drizzle, 600-699 is Snow
                if (conditionId >= 300 && conditionId < 700) {
                    if (!rainStart) {
                        rainStart = getHourTime(item.dt);
                        isRain = true;
                    }
                    rainEnd = getHourTime(item.dt);
                }
            }

            if (isRain && rainStart) {
                iconClass = (list[0].weather[0].id >= 600 && list[0].weather[0].id < 700) ? 'snow-icon' : 'rain-icon';
                message = `Heads up! ${iconClass === 'snow-icon' ? 'Snow' : 'Rain'} expected from <strong>${rainStart}</strong> until approximately <strong>${rainEnd}</strong>.`;
                bannerColor = 'bg-blue-100 border-blue-400 text-blue-700';
            }
            
            const iconSvg = iconClass === 'rain-icon' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a8 8 0 00-8 8c0 1.258.423 2.41 1.139 3.332L3 17h14l-.139-1.668A8 8 0 0010 2zm3 10a1 1 0 100-2 1 1 0 000 2zM7 12a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
            ` : iconClass === 'snow-icon' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M11 2a1 1 0 00-2 0v2.793l-1.646-.646a1 1 0 00-1.28.98l.646 1.646H5a1 1 0 000 2h1.492l-.646 1.646a1 1 0 00.98 1.28l1.646-.646V18a1 1 0 002 0v-2.793l1.646.646a1 1 0 001.28-.98l-.646-1.646H15a1 1 0 000-2h-1.492l.646-1.646a1 1 0 00-.98-1.28L13 4.793V2z"/>
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM4 10a6 6 0 1112 0 6 6 0 01-12 0z" clip-rule="evenodd"/>
                </svg>
            `;


            const predictionBanner = document.createElement('div');
            predictionBanner.className = `p-3 mb-4 rounded-lg ${bannerColor} font-semibold flex items-center shadow-lg`;
            predictionBanner.innerHTML = iconSvg + `<span class="flex-grow">${message}</span>`;
            
            // Insert the new banner after the main header
            const header = document.querySelector('header');
            if (header) {
                // Remove old prediction banner if exists
                let oldBanner = document.getElementById('predictionBanner');
                if (oldBanner) oldBanner.remove();

                predictionBanner.id = 'predictionBanner';
                header.parentNode.insertBefore(predictionBanner, header.nextSibling);
            }
        }


        // Generates the AI Insight summary
        async function generateInsight(cityName, weatherData) {
            insightLoading.style.display = 'flex';
            insightContent.textContent = '';
            insightCard.classList.remove('hidden');

            // CRITICAL: Ensure correct converted temperature is used for AI prompt
            const temp = convertTemp(weatherData.main.temp);
            const unit = isCelsius ? 'C' : 'F';
            const wind = convertWindSpeed(weatherData.wind.speed);
            const description = weatherData.weather[0].description;
            const humidity = weatherData.main.humidity;
            const feelsLike = convertTemp(weatherData.main.feels_like);

            const systemPrompt = "You are AeroView Insight, a world-class weather assistant with a friendly, witty, and concise personality. Your goal is to give a single, short paragraph (under 40 words) summary of the current weather, noting temperature, conditions, and offering one practical piece of advice (e.g., grab a coffee, grab a jacket, perfect day for a walk). Do not use bullet points or lists. Start your summary by stating the city name.";
            
            const userQuery = `Summarize the current weather for ${cityName}: Temperature is ${temp}Â°${unit} (feels like ${feelsLike}Â°${unit}), with ${description} and ${wind.value} ${wind.unit} winds. Humidity is ${humidity}%.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let currentRetry = 0;

            const apiKey = ""; // Will be injected by Canvas for fetch environment

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // Handle non-OK status codes, especially 429 (rate limit) or 403 (forbidden)
                        const errorText = await response.text();
                        throw new Error(`API error: ${response.status} - ${errorText.substring(0, 100)}...`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        insightContent.innerHTML = text.replace(/\n/g, '<br>');
                        insightLoading.style.display = 'none';
                        return;
                    }
                } catch (error) {
                    console.error("AI Insight Error:", error);
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // Fallback after all retries fail
            insightContent.textContent = "AI Insight temporarily unavailable. Please try again later.";
            insightLoading.style.display = 'none';
        }


        // --- PRIMARY API CALL ---

        // Main function to fetch all weather data
        async function getWeather(location = null) {
            showLoading();
            clearMessage();
            
            let cityQuery = cityInput.value.trim();
            let url;

            if (location) {
                // Search by coordinates (Geolocation)
                // CRITICAL FIX: Removed &units=metric here to return Kelvin (K)
                url = `${CURRENT_WEATHER_URL}?lat=${location.lat}&lon=${location.lon}&appid=${OPENWEATHER_API_KEY}`;
                cityQuery = 'Your Current Location'; // Use friendly name for UI
                cityInput.dataset.lastSearch = cityQuery; // Store for refresh
            } else if (cityQuery) {
                // Search by city name
                
                // Sanitize city name: Strip state/country if present (e.g., "Reno, NV" -> "Reno")
                const parts = cityQuery.split(',').map(s => s.trim());
                const apiCityName = parts[0]; 
                
                // CRITICAL FIX: Removed &units=metric here to return Kelvin (K)
                url = `${CURRENT_WEATHER_URL}?q=${apiCityName}&appid=${OPENWEATHER_API_KEY}`;
                cityInput.dataset.lastSearch = cityQuery; // Store original search string
            } else {
                showMessage("Please enter a city name or grant location access.", false);
                return;
            }
            
            try {
                // 1. Fetch Current Weather
                // CRITICAL FIX: Ensure forecast also returns Kelvin (K) by omitting the units= parameter
                const [weatherResponse, forecastResponse] = await Promise.all([
                    fetch(url),
                    fetch(url.replace(CURRENT_WEATHER_URL, FORECAST_URL)),
                ]);

                if (!weatherResponse.ok) {
                    const errorData = await weatherResponse.json();
                    showMessage(`City not found: ${cityQuery}. Please check the spelling.`, true);
                    return;
                }

                currentWeatherData = await weatherResponse.json();
                forecastWeatherData = await forecastResponse.json();
                
                // 2. Display Weather and Forecast
                displayCurrentWeather(currentWeatherData);
                displayForecast(forecastWeatherData);
                displayPredictionTimeline(forecastWeatherData); // Show the predictive timeline
                
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessage("Failed to connect to weather service. Please try again later.", true);
            }
        }


        // --- EVENT LISTENERS ---

        // Toggles Unit (C/F)
        function toggleUnits(setCelsius) {
            isCelsius = setCelsius;
            saveSetting('isCelsius', isCelsius);
            
            celsiusBtn.classList.toggle('unit-active', isCelsius);
            celsiusBtn.classList.toggle('unit-inactive', !isCelsius);
            fahrenheitBtn.classList.toggle('unit-active', !isCelsius);
            fahrenheitBtn.classList.toggle('unit-inactive', isCelsius);

            if (currentWeatherData) {
                displayCurrentWeather(currentWeatherData);
                displayForecast(forecastWeatherData);
            }
        }

        // Toggles Basic/Advanced Details
        function toggleDetails(setAdvanced) {
            isAdvanced = setAdvanced;
            saveSetting('isAdvanced', isAdvanced);

            basicBtn.classList.toggle('unit-active', !isAdvanced);
            basicBtn.classList.toggle('unit-inactive', isAdvanced);
            advancedBtn.classList.toggle('unit-active', isAdvanced);
            advancedBtn.classList.toggle('unit-inactive', !isAdvanced);

            if (currentWeatherData) {
                displayCurrentWeather(currentWeatherData);
            }
        }

        // --- Event Binding ---
        
        searchButton.addEventListener('click', () => getWeather());
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                getWeather();
                historyDisplay.classList.add('hidden'); // Hide dropdown on search
            }
        });
        refreshButton.addEventListener('click', () => {
            if (cityInput.dataset.lastSearch) {
                cityInput.value = cityInput.dataset.lastSearch; // Restore input value for fetch function logic
                getWeather();
            }
        });
        
        celsiusBtn.addEventListener('click', () => toggleUnits(true));
        fahrenheitBtn.addEventListener('click', () => toggleUnits(false));
        
        basicBtn.addEventListener('click', () => toggleDetails(false));
        advancedBtn.addEventListener('click', () => toggleDetails(true));

        // Search Dropdown & History Handlers
        cityInput.addEventListener('input', (e) => {
            renderSearchDropdown(e.target.value);
            // Show Search button if typing
            refreshButton.style.display = 'none';
            searchButton.style.display = 'block';
        });
        cityInput.addEventListener('focus', () => renderSearchDropdown(cityInput.value));
        cityInput.addEventListener('blur', () => {
            // Delay hiding the dropdown to allow click events to register
            setTimeout(() => {
                historyDisplay.classList.add('hidden');
            }, 200);
        });
        
        clearHistoryBtn.addEventListener('click', () => {
            saveSetting('searchHistory', []);
            renderSearchDropdown();
        });
        
        // About Modal Handlers
        aboutBtn.addEventListener('click', () => aboutModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => aboutModal.classList.add('hidden'));
        
        // 3D Map View Handler
        mapBtn.addEventListener('click', () => {
            if (currentWeatherData) {
                const lat = currentWeatherData.coord.lat;
                const lon = currentWeatherData.coord.lon;
                
                // Google Maps URL optimized for 3D/Earth View
                const mapUrl = `https://www.google.com/maps/@${lat},${lon},1500m/data=!3m1!1e3`;
                window.open(mapUrl, '_blank');
            }
        });

        // --- INITIALIZATION ---

        function initGeolocation() {
            if (navigator.geolocation) {
                // Initial prompt: Try to get user's location
                showMessage("Attempting to get your location...", false);
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Success: Fetch weather for current coordinates
                        getWeather({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        // Failure (User denied or timeout): Fallback to welcome state
                        console.warn('Geolocation failed or denied:', error.message);
                        showWelcome();
                    }
                );
            } else {
                // Geolocation not supported: Fallback to welcome state
                showWelcome();
            }
        }

        window.onload = function () {
            applySeasonalDecorations();
            loadState(); // Load C/F and Basic/Advanced settings

            // Load last searched city if available
            const history = loadSetting('searchHistory', []);
            if (history.length > 0) {
                cityInput.value = history[0]; // Set last searched city
                getWeather(); // Automatically search last city
            } else {
                // If no history, ask for geolocation
                initGeolocation();
            }

            // Attach event listener for refresh/search toggle logic
            cityInput.addEventListener('input', () => {
                if (cityInput.dataset.lastSearch) {
                    refreshButton.style.display = 'none';
                    searchButton.style.display = 'block';
                }
            });
        };
    </script>
</body>
</html>









